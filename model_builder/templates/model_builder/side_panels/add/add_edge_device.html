{% extends "model_builder/side_panels/side_panel_structure.html" %}
{% load static %}

{% block panel_body %}
    <form id="sidePanelForm"
        hx-post="/model_builder/add-object/{{ object_type }}/"
        hx-target="#edge-devices-list"
        hx-swap="beforeend"
        hx-disabled-elt="button"
        hx-on::after-request="closeAndEmptySidePanel()"
        hx-vals="js:{
            storage_form_data: Object.fromEntries(new FormData(document.getElementById('formStorage')))
        }">
    {% include "model_builder/side_panels/add/add_form_content.html" %}
    </form>
    <form id="formStorage" class="edge-computer-only">
        {% include "model_builder/side_panels/add/add_form_content.html" with obj_type=storage_obj_type form_sections=storage_form_sections dynamic_form_data=storage_dynamic_form_data %}
    </form>

    <div class="mb-3">
        <p class="mt-4 edge-computer-only">
            You will be able to edit all attributes of the created edge device later in the dedicated panel.
        </p>
    </div>

    <div class="mb-3">
        <button
                    id="btn-submit-form"
                    class="btn btn-primary rounded-pill w-100"
                    onclick="document.getElementById('sidePanelForm').requestSubmit()"
            >
                Save
        </button>
    </div>

    <script>
        // Show/hide storage form based on selected edge device type
        function updateStorageFormVisibility() {
            const deviceTypeSelect = document.getElementById('type_object_available');
            const storageElements = document.querySelectorAll('.edge-computer-only');

            if (deviceTypeSelect) {
                const selectedType = deviceTypeSelect.value;
                storageElements.forEach(element => {
                    if (selectedType === 'EdgeComputer') {
                        element.style.display = '';
                    } else {
                        element.style.display = 'none';
                    }
                });
            }
        }

        // Initial visibility setup
        document.addEventListener('DOMContentLoaded', updateStorageFormVisibility);

        // Update visibility when device type changes
        const deviceTypeSelect = document.getElementById('type_object_available');
        if (deviceTypeSelect) {
            deviceTypeSelect.addEventListener('change', updateStorageFormVisibility);
        }

        // Trigger on dynamic form initialization
        document.addEventListener('initDynamicForm', updateStorageFormVisibility);
    </script>
{% endblock %}
